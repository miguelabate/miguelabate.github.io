<!DOCTYPE html>
<html>
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1">
    <title>Protobuf communication between Js-client and Go-server - Miguel Abate</title>

    <style type="text/css">
        img.wp-smiley,
        img.emoji {
            display: inline !important;
            border: none !important;
            box-shadow: none !important;
            height: 1em !important;
            width: 1em !important;
            margin: 0 .07em !important;
            vertical-align: -0.1em !important;
            background: none !important;
            padding: 0 !important;
        }
    </style>
    
    <link rel='stylesheet' href='/css/style.css' type='text/css' media='all' />
    <link rel='stylesheet' href='/css/custom.css' type='text/css' media='all' />
    <link rel='stylesheet' href='/css/syntax.css' type='text/css' media='all' />
    <link rel='stylesheet' href='/css/toc.css' type='text/css' media='all' />
    
  


    <meta property="og:url" content="/protobuf-communication-between-js-client-and-go-server/">
  <meta property="og:site_name" content="Miguel Abate">
  <meta property="og:title" content="Protobuf communication between Js-client and Go-server">
  <meta property="og:description" content="In this article, I present a small Proof of Concept of communication between a browser (Js) and a server (Golang) using Protocol Buffers over Websockets. This idea emerged as part of a bigger personal project I’m working on and will probably show here in the future.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2019-12-05T14:29:51+02:00">
    <meta property="article:modified_time" content="2019-12-05T14:29:51+02:00">
    <meta property="article:tag" content="Go">
    <meta property="article:tag" content="Js">
    <meta property="article:tag" content="Html">
    <meta property="article:tag" content="Websocket">
    <meta property="article:tag" content="Protobuf">

    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Protobuf communication between Js-client and Go-server">
  <meta name="twitter:description" content="In this article, I present a small Proof of Concept of communication between a browser (Js) and a server (Golang) using Protocol Buffers over Websockets. This idea emerged as part of a bigger personal project I’m working on and will probably show here in the future.">

</head>

    <body class="two-column">
        <a href="#content">Skip to content</a>
<div class="wrapper">
    <header role="banner" class="banner widgets columns-1">
        <a href="/" rel="home">
            <h1 class="site" style="font-size: 40px">Miguel Abate</h1>
            <p></p>
        </a>
        <nav role="navigation" aria-label="Primary Navigation">

            <ul class="menu">
                <li class="menu-item "><a class="menu__link" href="/post/">POSTS</a></li>
                <li class="menu-item "><a class="menu__link" href="/links/">LINKS</a></li>
                <li class="menu-item "><a class="menu__link" href="/about/">ABOUT ME</a></li>
            </ul>
            <select onChange="location.href=value;">
                <option value="/post/" class="menu-item menu-item-type-custom menu-item-object-custom" >POSTS</option>
                <option value="/links/" class="menu-item menu-item-type-custom menu-item-object-custom" >LINKS</option>
                <option value="/about/" class="menu-item menu-item-type-custom menu-item-object-custom" >ABOUT ME</option>
            </select>
        </nav>
    </header>

    <br>
    <div style="width: 100%; max-height: 100px; text-align: center;">
       
</div>

    <div class="breadcrumbs">
        
    </div>
        <div id="content" class="content">

<main role="main">
    <article role="article" class="post type-post format-standard hentry">
        <header class="post-header">
            <h1>Protobuf communication between Js-client and Go-server</h1>
            <div class="post-details">
                <a rel="bookmark">
                    <time datetime="2019-12-05T125:229:516">2019-12-05</time>
                </a>
				
<span style="float: right;">
    <div id="fb-root" style="height: 100%;"></div>
    
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.2"></script>
    
    <div class="fb-share-button" data-href="/protobuf-communication-between-js-client-and-go-server/" data-layout="button_count" data-size="small">
        <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=%2fprotobuf-communication-between-js-client-and-go-server%2f" class="fb-xfbml-parse-ignore">Share</a>
    </div>
    &nbsp;
    <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-text="Protobuf communication between Js-client and Go-server" data-url="/protobuf-communication-between-js-client-and-go-server/" data-show-count="false">Tweet</a>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    &nbsp;
    
</span>

            </div>
        </header>

        <div class="post-content">
            <p>In this article, I present a small Proof of Concept of communication between a browser (Js) and a server (Golang) using Protocol Buffers over Websockets. This idea emerged as part of a bigger personal project I&rsquo;m working on and will probably show here in the future.</p>
<h1 id="objective-of-the-project">Objective of the project</h1>
<p>The functionality of this proof of concept is pretty basic but it is a good showcase for quite a few technologies that are interesting to experiment with.<br>
The idea is to create a persons database that is searchable and updatable from the browser.<br>
For the frontend (browser), I will use plain javascript.<br>
For the server, I will use Go.<br>
For communication between the two, I will use WebSockets and the data will be serialized in the protocol buffers binary format.</p>
<p><img src="/js-proto-ws-schema.png" alt="Schema" title="Basic component schema"></p>
<h1 id="protobuf">Protobuf</h1>
<p>If you are not familiar with Protocol Buffers, I&rsquo;d recommend starting with the official page <a href="https://developers.google.com/protocol-buffers/">https://developers.google.com/protocol-buffers/</a>.<br>
In short, as the site says, &ldquo;Protocol buffers are a language-neutral, platform-neutral extensible mechanism for serializing structured data&rdquo;</p>
<p>One of the main advantages of protocol buffer binary format, over other ways of data serialization (E.g: XML, JSON), is that the messages are smaller and transmitted faster. Unlike XML, protocol buffer messages are not self-describing, so, when reading or writing, you will always need the message definition (the .proto file).<br>
Protobuf are supported by every major language.</p>
<p>This is very nice, but how does it look like in this case? You can check it out here:<br>
<a href="https://github.com/miguelabate/js-go-proto-poc/blob/master/proto/message.proto">message.proto</a></p>
<p>Some decisions are worth mentioning. I define two message types that are used as events to trigger actions in the systems. Such as insert a Person or query Persons.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-proto" data-lang="proto"><span style="display:flex;"><span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">UpsertPerson</span> {<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    Person person <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">QueryPerson</span> {<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">string</span> name_regexp <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>A trick I do to handle this events between client and server, is wrapping them into another generic message like this.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-proto" data-lang="proto"><span style="display:flex;"><span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">ClientEvent</span> {<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">oneof</span> event {<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        UpsertPerson upsert_person <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        QueryPerson query_person <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    }<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>In this way, when I get a ClientEvent message in the server, I can easily figure out what is the actual event and deserialize correctly.</p>
<p>Then, I have he model itself with messages defined like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-proto" data-lang="proto"><span style="display:flex;"><span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">Person</span> {<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">string</span> name <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">repeated</span> <span style="color:#66d9ef">string</span> characteristics <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">float</span> height <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">int32</span> years <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">repeated</span> Address known_addresses <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">bool</span> has_police_record <span style="color:#f92672">=</span> <span style="color:#ae81ff">6</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    Gender gender <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>No big deal here. Just the Person entity with various fields to showcase different attribute types.</p>
<p>Another trick I&rsquo;m using is defining a message called PersonDB like:</p>
<pre tabindex="0"><code>message PersonDB {
    repeated Person persons = 1;
}
</code></pre><p>I use this to serialize and deserialize the whole dataset from/to disk.</p>
<p>Going on, as mentioned earlier, the .proto file is just the definition of the messages I will be using. Now I need to generate actual code from this proto so my client and server application can understand. This means I will have to generate code in Golang and in Js.</p>
<h2 id="generating-protobuf-code-for-golang">Generating protobuf code for Golang</h2>
<ul>
<li>
<p>Download and install protobuf compiler from <a href="https://developers.google.com/protocol-buffers/docs/downloads.html">https://developers.google.com/protocol-buffers/docs/downloads.html</a></p>
</li>
<li>
<p>Install golang proto plugin doing</p>
</li>
</ul>
<pre tabindex="0"><code>go get -u github.com/golang/protobuf/protoc-gen-go
</code></pre><ul>
<li>Generate the source code for Go with the following command</li>
</ul>
<pre tabindex="0"><code>protoc --proto_path=../ --go_out=. ../proto/message.proto
</code></pre><h2 id="generating-protobuf-code-for-js">Generating protobuf code for Js</h2>
<ul>
<li>
<p>Install protoc (already have it from previous step)</p>
</li>
<li>
<p>Generate the source code for Js with the following command</p>
</li>
</ul>
<pre tabindex="0"><code>protoc --proto_path=../ --js_out=library=MyMessages,binary:build/gen ../proto/message.proto
</code></pre><h1 id="the-server-go">The server: Go</h1>
<p>Let&rsquo;s take a look at the main file that makes the server<br>
<a href="https://github.com/miguelabate/js-go-proto-poc/blob/master/go-server-proto/main.go">https://github.com/miguelabate/js-go-proto-poc/blob/master/go-server-proto/main.go</a></p>
<p>To handle the websocket connections, I use the convenient Gorilla WebSockets library <a href="github.com/gorilla/websocket">github.com/gorilla/websocket</a>. This library handles the connection and the upgrade to WS.</p>
<p>E.g.:</p>
<p>Start the application with a basic http server listening on 8081 and set the ws function to handle the request</p>
<pre tabindex="0"><code>    var addr = flag.String(&#34;addr&#34;, &#34;:8081&#34;, &#34;http service address&#34;)
.
.
.
	http.HandleFunc(&#34;/ws&#34;, ws)
	log.Fatal(http.ListenAndServe(*addr, nil))
</code></pre><p>The start of the ws function that handles the request looks like:</p>
<pre tabindex="0"><code>func ws(w http.ResponseWriter, r *http.Request) {
	c, err := upgrader.Upgrade(w, r, nil)
	if err != nil {
		log.Print(&#34;upgrade:&#34;, err)
		return
	}
	defer c.Close()
.
.
.
</code></pre><p>As you can see, the first thing I do is upgrade the connection to WS and then I can easily use it for reading from the WS:</p>
<pre tabindex="0"><code>_, message, err := c.ReadMessage()
</code></pre><p>And writing:</p>
<pre tabindex="0"><code>err = c.WriteMessage(websocket.BinaryMessage, dataToSend)
</code></pre><p>A nice tip here is that the default WS upgrader won&rsquo;t be able to handle Cross Origin connections, making it hard to do local development, so a trick here is to define your own upgrader like:</p>
<pre tabindex="0"><code>var upgrader = websocket.Upgrader{
	ReadBufferSize:  1024,
	WriteBufferSize: 1024,
	CheckOrigin: func(r *http.Request) bool { //doing this to allow cross origin for now
		return true
	},
}
</code></pre><p>That&rsquo;s about it for the WebSocket connection handling. Now, other operations that I need to do in the server is deserialize the proto messages like:</p>
<pre tabindex="0"><code>clientEvent := &amp;mymessages.ClientEvent{}
err = proto.Unmarshal(message, clientEvent)
</code></pre><p>Or serialize to send to the client:</p>
<pre tabindex="0"><code>result := new(mymessages.QueryPersonResult)
result.Persons = foundPersons

dataToSend, err := proto.Marshal(result)
</code></pre><p>Other thing I do in the server, is persisting the messages to disk:</p>
<pre tabindex="0"><code>persondb_bytes, _ := json.Marshal(personsdb_obj)
err := ioutil.WriteFile(&#34;myPersonsDB&#34;, persondb_bytes, 0644)
</code></pre><p>Then I can restore it between server restarts.</p>
<h1 id="the-client-js">The client: Js</h1>
<p>On the client side, I just have an html form with fields related to our Person entity and some buttons to do actions like open a WS connection, send a Person message to our persistence and query.</p>
<p>The main code for this can be  seen here <a href="https://github.com/miguelabate/js-go-proto-poc/blob/master/js-client-proto/main.js">https://github.com/miguelabate/js-go-proto-poc/blob/master/js-client-proto/main.js</a></p>
<p>In our html we must include the necessary dependencies to work with js proto, and google clousures (the format used to generate the js sources based on the protos).</p>
<p>Can get these dependencies from:</p>
<ul>
<li>
<p>include the protobuf js libs:<br>
<a href="mailto:git@github.com">git@github.com</a>:protocolbuffers/protobuf.git<br>
<a href="https://github.com/protocolbuffers/protobuf/tree/master/js">https://github.com/protocolbuffers/protobuf/tree/master/js</a></p>
</li>
<li>
<p>get the closure library from google to be able to import the sources generated from the proto<br>
<a href="https://github.com/google/closure-library">https://github.com/google/closure-library</a></p>
</li>
</ul>
<p>The includes should look like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>  <span style="color:#75715e">&lt;!-- closure lib from google --&gt;</span>
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;libs-js/closure-library/closure/goog/base.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">&lt;!-- Protobuf --&gt;</span>
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;libs-js/constants.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;libs-js/utils.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;libs-js/arith.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;libs-js/decoder.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;libs-js/encoder.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;libs-js/reader.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;libs-js/writer.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;libs-js/map.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;libs-js/message.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">&lt;!-- Generated from proto --&gt;</span>
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;./build/gen/MyMessages.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
</span></span></code></pre></div><p>To connect to the WebSocket server I use the default HTML5 WebScoket capabilities.</p>
<p>In the following piece of JS code, it can be seen how to connect to the WS server and react to events, also it shows how to serialize and deserialize protobuf messages</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>    document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#34;open&#34;</span>).<span style="color:#a6e22e">onclick</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">evt</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">ws</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ws</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WebSocket</span>(<span style="color:#e6db74">&#34;ws://127.0.0.1:8081/ws&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ws</span>.<span style="color:#a6e22e">binaryType</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;arraybuffer&#39;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ws</span>.<span style="color:#a6e22e">onopen</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">evt</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;OPEN&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ws</span>.<span style="color:#a6e22e">onclose</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">evt</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;CLOSE&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">ws</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ws</span>.<span style="color:#a6e22e">onmessage</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">evt</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">arrayBuffer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">data</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">message</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">QueryPersonResult</span>.<span style="color:#a6e22e">deserializeBinary</span>(<span style="color:#a6e22e">arrayBuffer</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">toObject</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">persons_retrieved</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">getPersonsList</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;QUERY RESULT TOTAL:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">persons_retrieved</span>.<span style="color:#a6e22e">length</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">persons_retrieved</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;QUERY RESULT:&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">prettyStringPerson</span>(<span style="color:#a6e22e">persons_retrieved</span>[<span style="color:#a6e22e">i</span>]));
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ws</span>.<span style="color:#a6e22e">onerror</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">evt</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;ERROR: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">evt</span>.<span style="color:#a6e22e">data</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>    };
</span></span></code></pre></div><p>Another important piece of code is the one that sends (and serializes) to the WS server</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>    document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#34;send&#34;</span>).<span style="color:#a6e22e">onclick</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">evt</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">ws</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">message</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">ClientEvent</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">upsertEvent</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">UpsertPerson</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">newPerson</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Person</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">newPerson</span>.<span style="color:#a6e22e">setName</span>(<span style="color:#a6e22e">inputName</span>.<span style="color:#a6e22e">value</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">newPerson</span>.<span style="color:#a6e22e">setCharacteristicsList</span>(<span style="color:#a6e22e">inputCharacteristics</span>.<span style="color:#a6e22e">value</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#34;;&#34;</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">newPerson</span>.<span style="color:#a6e22e">setYears</span>(<span style="color:#a6e22e">inputYears</span>.<span style="color:#a6e22e">value</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">newPerson</span>.<span style="color:#a6e22e">setHeight</span>(<span style="color:#a6e22e">inputHeight</span>.<span style="color:#a6e22e">value</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">newPerson</span>.<span style="color:#a6e22e">setKnownAddressesList</span>(<span style="color:#a6e22e">getAddressesList</span>(<span style="color:#a6e22e">inputAddresses</span>.<span style="color:#a6e22e">value</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">newPerson</span>.<span style="color:#a6e22e">setGender</span>(<span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Gender</span>[<span style="color:#a6e22e">inputGender</span>.<span style="color:#a6e22e">value</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">newPerson</span>.<span style="color:#a6e22e">setHasPoliceRecord</span>((<span style="color:#a6e22e">inputPolRecord</span>.<span style="color:#a6e22e">value</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;true&#39;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">upsertEvent</span>.<span style="color:#a6e22e">setPerson</span>(<span style="color:#a6e22e">newPerson</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">setUpsertPerson</span>(<span style="color:#a6e22e">upsertEvent</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;SENT: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">toString</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ws</span>.<span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">serializeBinary</span>(), { <span style="color:#a6e22e">binary</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span> });
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>    };
</span></span></code></pre></div><h1 id="conclusion">Conclusion</h1>
<p>I have presented small POC showing how to set up a WebSocket server in GoLang and communicate with a browser JS client using protobuf messages. Interesting if you need to develop some kind of project (maybe a game?) that needs to keep a bidirectional connection between client-server.</p>
        </div>



        <footer class="post-footer">
                
                
                
                <span class="post-categories">
                        <a href="/categories/poc/">POC</a>&emsp;
                        
                </span>
                
        
                
                
                
                <span class="post-tags">
                </span>
                
        </footer>
        
<table cellspacing="15" style="width:100%; border: none;">
    <tr>
        <td style="text-align: center; border: none; padding: 0px;">
        </td>
        <td style="text-align: center; border: none; padding: 0px;">
        </td>
    </tr>
</table>

        
	
	

    </article>

    
    <nav class="navigation post-navigation" role="navigation">
        <div class="nav-links">
            <div class="nav-previous">
                
            </div>
            <div class="nav-next">
                
                <a class="next" href="/reddit-urls-scraper/"> Reddit Urls Scraper</a>
                
            </div>
        </div>
    </nav>
    <section>
        
    </section>
    

</main>


        <div class="sidebar1 widgets columns-1">

    <aside>
    
</aside>
    <aside class="widget widget_categories">
        <h2>Categories</h2>
        <ul class="widget__list"><li class="cat-item cat-item-2">
                <a href="/categories/bash/">Bash (1)</a>
            </li><li class="cat-item cat-item-2">
                <a href="/categories/bits/">Bits (1)</a>
            </li><li class="cat-item cat-item-2">
                <a href="/categories/devops/">DevOps (1)</a>
            </li><li class="cat-item cat-item-2">
                <a href="/categories/frontend/">Frontend (1)</a>
            </li><li class="cat-item cat-item-2">
                <a href="/categories/go/">Go (1)</a>
            </li><li class="cat-item cat-item-2">
                <a href="/categories/poc/">POC (1)</a>
            </li><li class="cat-item cat-item-2">
                <a href="/categories/programming/">Programming (1)</a>
            </li><li class="cat-item cat-item-2">
                <a href="/categories/rust/">Rust (1)</a>
            </li><li class="cat-item cat-item-2">
                <a href="/categories/server/">Server (1)</a>
            </li><li class="cat-item cat-item-2">
                <a href="/categories/tool/">Tool (3)</a>
            </li>
        </ul>
    </aside>

    <aside class="widget widget_tag_cloud">
        <h2>Tags</h2>
        <div class="tagcloud"><a class="tag-cloud-link" href="/tags/bash/" title="bash" style="font-size: 12pt;">Bash</a>&emsp;<a class="tag-cloud-link" href="/tags/command-line/" title="command line" style="font-size: 12pt;">Command Line</a>&emsp;<a class="tag-cloud-link" href="/tags/devops/" title="devops" style="font-size: 12pt;">Devops</a>&emsp;<a class="tag-cloud-link" href="/tags/ebook/" title="ebook" style="font-size: 12pt;">EBook</a>&emsp;<a class="tag-cloud-link" href="/tags/geo/" title="geo" style="font-size: 12pt;">Geo</a>&emsp;<a class="tag-cloud-link" href="/tags/go/" title="go" style="font-size: 12pt;">Go</a>&emsp;<a class="tag-cloud-link" href="/tags/golang/" title="golang" style="font-size: 12pt;">Golang</a>&emsp;<a class="tag-cloud-link" href="/tags/html/" title="html" style="font-size: 12pt;">Html</a>&emsp;<a class="tag-cloud-link" href="/tags/js/" title="js" style="font-size: 12pt;">Js</a>&emsp;<a class="tag-cloud-link" href="/tags/jwt/" title="jwt" style="font-size: 12pt;">Jwt</a>&emsp;<a class="tag-cloud-link" href="/tags/leaflet/" title="leaflet" style="font-size: 12pt;">Leaflet</a>&emsp;<a class="tag-cloud-link" href="/tags/linux/" title="linux" style="font-size: 12pt;">Linux</a>&emsp;<a class="tag-cloud-link" href="/tags/nginx/" title="nginx" style="font-size: 12pt;">Nginx</a>&emsp;<a class="tag-cloud-link" href="/tags/poc/" title="poc" style="font-size: 12pt;">POC</a>&emsp;<a class="tag-cloud-link" href="/tags/programming/" title="programming" style="font-size: 12pt;">Programming</a>&emsp;<a class="tag-cloud-link" href="/tags/protobuf/" title="protobuf" style="font-size: 12pt;">Protobuf</a>&emsp;<a class="tag-cloud-link" href="/tags/reddit/" title="reddit" style="font-size: 12pt;">Reddit</a>&emsp;<a class="tag-cloud-link" href="/tags/rust/" title="rust" style="font-size: 12pt;">Rust</a>&emsp;<a class="tag-cloud-link" href="/tags/server/" title="server" style="font-size: 12pt;">Server</a>&emsp;<a class="tag-cloud-link" href="/tags/ssl/" title="ssl" style="font-size: 12pt;">Ssl</a>&emsp;<a class="tag-cloud-link" href="/tags/tool/" title="tool" style="font-size: 12pt;">Tool</a>&emsp;<a class="tag-cloud-link" href="/tags/websocket/" title="websocket" style="font-size: 12pt;">Websocket</a>&emsp;
        </div>
    </aside>

    <aside class="widget widget_recent_entries">
        <h2>Recent Posts</h2>
        <ul>
            <li>
                <a href="/aleka-a-schema-agnostic-protobuf-decoder/">Aleka: a schema agnostic protobuf decoder</a>
            </li>
            <li>
                <a href="/jwt-token-auth-in-golang/">Jwt Token Auth in Golang</a>
            </li>
            <li>
                <a href="/leaflet-animated-marker/">Leaflet animated marker</a>
            </li>
            <li>
                <a href="/nginx-ssl-reverse-proxy/">Nginx SSL Reverse Proxy</a>
            </li>
            <li>
                <a href="/bulk-ebook-converter/">Bulk eBook Converter</a>
            </li>
            <li>
                <a href="/reddit-urls-scraper/">Reddit Urls Scraper</a>
            </li>
            <li>
                <a href="/protobuf-communication-between-js-client-and-go-server/">Protobuf communication between Js-client and Go-server</a>
            </li>
        </ul>
    </aside>

    <aside class="widget widget_archive">
        <h2>Archives</h2>
        <ul>
        </ul>
    </aside>

</div>
        </div>
        </div>
<footer role="contentinfo" class="document-footer contentinfo widgets columns-1">

    <aside class="widget widget_text">
        <div class="textwidget">
            <p>© Miguel Abate / Powered by <a href="https://gohugo.io" target="_blank">Hugo</a> with theme <a href="https://github.com/tosi29/inkblotty" target="_blank">Inkblotty</a></p>
        </div>
    </aside>
</footer>
</div>

    </body>
</html>
